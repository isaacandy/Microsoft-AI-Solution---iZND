name: Deploy static site to 4EVERLAND

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Archive site files (replace PROXY_URL placeholder if provided)
        env:
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          if [ -n "$PROXY_URL" ]; then
            echo "Replacing __PROXY_URL__ placeholder with provided PROXY_URL"
            # Use a temporary file to avoid altering history
            sed "s|__PROXY_URL__|$PROXY_URL|g" index.html > index._tmp.html || cp index.html index._tmp.html
            mv index._tmp.html index.html
          else
            echo "No PROXY_URL secret provided; leaving __PROXY_URL__ placeholder in index.html"
          fi
          zip -r site.zip index.html styles.css *.html || true

      - name: Upload to 4EVERLAND (placeholder)
        env:
          FOURVERLAND_API_URL: ${{ secrets.FOREVERLAND_API_URL }}
          FOREVERLAND_API_KEY: ${{ secrets.FOREVERLAND_API_KEY }}
        run: |
          echo "Uploading site.zip to 4EVERLAND..."
          # Replace the endpoint and form params below with the exact 4EVERLAND upload API or CLI command
          if [ -z "$FOURVERLAND_API_URL" ] || [ -z "$FOREVERLAND_API_KEY" ]; then
            echo "Missing 4EVERLAND secrets. Set FOREVERLAND_API_URL and FOREVERLAND_API_KEY in repository secrets." >&2
            exit 1
          fi

          # Example generic upload using a Bearer token. Update path /upload and fields per 4EVERLAND docs.
          RESPONSE=$(curl -s -X POST "$FOURVERLAND_API_URL/upload" \
            -H "Authorization: Bearer $FOREVERLAND_API_KEY" \
            -F "file=@site.zip" )

          echo "Upload response:" 
          echo "$RESPONSE"

      - name: Verify deployment (optional)
        env:
          DEPLOY_URL: ${{ secrets.FOREVERLAND_DEPLOY_URL }}
        run: |
          if [ -n "$DEPLOY_URL" ]; then
            echo "Checking $DEPLOY_URL"
            curl -fsS "$DEPLOY_URL" -o /dev/null || (echo "Health check failed" && exit 1)
            echo "Health check passed"
          else
            echo "No DEPLOY_URL secret configured; skipping verification. You can add the public URL returned by 4EVERLAND to repository secrets as FOREVERLAND_DEPLOY_URL to enable verification."
          fi

      - name: Deploy Cloudflare Worker
        uses: cloudflare/wrangler-action@2
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          working-directory: ./worker

      - name: (Optional) Set Worker env vars
        run: |
          echo "Set ETHERSCAN_API_KEY and PROVIDER_URL as Cloudflare Worker secrets via Wrangler or Cloudflare dashboard."
          echo "Example: npx wrangler secret put ETHERSCAN_API_KEY --env production (requires interactive input)."
        working-directory: ./worker
      - name: Non-interactive: Push Worker secrets from GitHub Secrets
        if: ${{ secrets.ETHERSCAN_API_KEY && secrets.PROVIDER_URL && secrets.CF_API_TOKEN }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          PROVIDER_URL: ${{ secrets.PROVIDER_URL }}
        run: |
          echo "Installing wrangler..."
          npm i -g wrangler@3 || true
          cd worker
          # Non-interactive secret put: echo value | wrangler secret put NAME
          echo "$ETHERSCAN_API_KEY" | wrangler secret put ETHERSCAN_API_KEY || (echo "Failed to set ETHERSCAN_API_KEY" && exit 1)
          echo "$PROVIDER_URL" | wrangler secret put PROVIDER_URL || (echo "Failed to set PROVIDER_URL" && exit 1)
          echo "Worker secrets set."

      - name: Compute Worker URL and set `PROXY_URL` repo secret
        id: compute-proxy
        if: ${{ secrets.CF_API_TOKEN && secrets.CF_ACCOUNT_ID }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          echo "Fetching Cloudflare workers subdomain for account $CF_ACCOUNT_ID"
          SUBDOMAIN=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/workers/subdomain" \
            -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" | jq -r '.result.subdomain')
          if [ -z "$SUBDOMAIN" ] || [ "$SUBDOMAIN" = "null" ]; then
            echo "Failed to get subdomain from Cloudflare API" >&2
            exit 1
          fi
          echo "Subdomain: $SUBDOMAIN"
          # Worker name from worker/wrangler.toml
          WORKER_NAME="microsoft-ai-proxy"
          PROXY_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
          echo "Computed PROXY_URL=$PROXY_URL"
          echo "proxy_url=$PROXY_URL" >> $GITHUB_OUTPUT

      - name: Set PROXY_URL repository secret
        uses: peter-evans/create-or-update-secret@v2
        if: ${{ steps.compute-proxy.outputs.proxy_url }}
        with:
          secret-name: PROXY_URL
          secret-value: ${{ steps.compute-proxy.outputs.proxy_url }}
